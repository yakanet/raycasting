var Mt=Object.defineProperty;var Pt=(t,e,o)=>e in t?Mt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var L=(t,e,o)=>Pt(t,typeof e!="symbol"?e+"":e,o);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=o(i);fetch(i.href,s)}})();const Et=6970,U=.5,nt=2,it=.5,kt=2,Lt=5,mt=10,st=.8,gt=.25;class ot{constructor(e,o,n,i){L(this,"r");L(this,"g");L(this,"b");L(this,"a");this.r=e,this.g=o,this.b=n,this.a=i}toStyle(){return`rgba(${Math.floor(this.r*255)}, ${Math.floor(this.g*255)}, ${Math.floor(this.b*255)}, ${this.a})`}}class y{constructor(e=0,o=0){L(this,"x");L(this,"y");this.x=e,this.y=o}setPolar(e,o=1){return this.x=Math.cos(e)*o,this.y=Math.sin(e)*o,this}clone(){return new y(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}set(e,o){return this.x=e,this.y=o,this}setScalar(e){return this.x=e,this.y=e,this}add(e){return this.x+=e.x,this.y+=e.y,this}sub(e){return this.x-=e.x,this.y-=e.y,this}div(e){return this.x/=e.x,this.y/=e.y,this}mul(e){return this.x*=e.x,this.y*=e.y,this}sqrLength(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.sqrLength())}angle(){return Math.atan2(this.y,this.x)}scale(e){return this.x*=e,this.y*=e,this}norm(){const e=this.length();return e===0?this:this.scale(1/e)}rot90(){const e=this.x;return this.x=-this.y,this.y=e,this}sqrDistanceTo(e){const o=e.x-this.x,n=e.y-this.y;return o*o+n*n}distanceTo(e){return Math.sqrt(this.sqrDistanceTo(e))}lerp(e,o){return this.x+=(e.x-this.x)*o,this.y+=(e.y-this.y)*o,this}dot(e){return this.x*e.x+this.y*e.y}map(e){return this.x=e(this.x),this.y=e(this.y),this}}class W{constructor(e=0,o=0,n=0){L(this,"x");L(this,"y");L(this,"z");this.x=e,this.y=o,this.z=n}clone(){return new W(this.x,this.y,this.z)}clone2(){return new y(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}copy2(e,o){return this.x=e.x,this.y=e.y,this.z=o,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}sqrLength(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.sqrLength())}scale(e){return this.x*=e,this.y*=e,this.z*=e,this}norm(){const e=this.length();return e===0?this:this.scale(1/e)}sqrDistanceTo(e){const o=e.x-this.x,n=e.y-this.y,i=e.z-this.z;return o*o+n*n+i*i}distanceTo(e){return Math.sqrt(this.sqrDistanceTo(e))}lerp(e,o){return this.x+=(e.x-this.x)*o,this.y+=(e.y-this.y)*o,this.z+=(e.z-this.z)*o,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}map(e){return this.x=e(this.x),this.y=e(this.y),this.z=e(this.z),this}}var B=(t=>(t[t.MovingForward=0]="MovingForward",t[t.MovingBackward=1]="MovingBackward",t[t.TurningLeft=2]="TurningLeft",t[t.TurningRight=3]="TurningRight",t[t.Count=4]="Count",t))(B||{}),q=(t=>(t[t.Hello=0]="Hello",t[t.PlayerJoined=1]="PlayerJoined",t[t.PlayerLeft=2]="PlayerLeft",t[t.PlayerMoving=3]="PlayerMoving",t[t.AmmaMoving=4]="AmmaMoving",t[t.AmmaThrowing=5]="AmmaThrowing",t[t.Ping=6]="Ping",t[t.Pong=7]="Pong",t[t.ItemSpawned=8]="ItemSpawned",t[t.ItemCollected=9]="ItemCollected",t[t.BombSpawned=10]="BombSpawned",t[t.BombExploded=11]="BombExploded",t))(q||{});const At=1,wt=4,Bt=4;function M(t){const e=t.size,o=At;return t.size+=o,{offset:e,size:o,read:n=>n.getUint8(e),write:(n,i)=>n.setUint8(e,i)}}function O(t){const e=t.size,o=wt;return t.size+=o,{offset:e,size:o,read:n=>n.getUint32(e,!0),write:(n,i)=>n.setUint32(e,i,!0)}}function S(t){const e=t.size,o=Bt;return t.size+=o,{offset:e,size:o,read:n=>n.getFloat32(e,!0),write:(n,i)=>n.setFloat32(e,i,!0)}}function D(t,e,o){return n=>n.byteLength==o&&t.read(n)==e}const rt=(()=>{const t={size:0},e=M(t),o=O(t),n=t.size,i=D(e,9,n);return{kind:e,index:o,size:n,verify:i}})(),A=(()=>{const t={size:0},e=M(t),o=O(t),n=S(t),i=S(t),s=S(t),r=S(t),c=S(t),a=S(t),h=S(t),p=t.size,w=D(e,10,p);return{kind:e,index:o,x:n,y:i,z:s,dx:r,dy:c,dz:a,lifetime:h,size:p,verify:w}})(),N=(()=>{const t={size:0},e=M(t),o=O(t),n=S(t),i=S(t),s=S(t),r=t.size,c=D(e,11,r);return{kind:e,index:o,x:n,y:i,z:s,size:r,verify:c}})(),F=(()=>{const t={size:0},e=M(t),o=M(t),n=O(t),i=S(t),s=S(t),r=t.size,c=D(e,8,r);return{kind:e,itemKind:o,index:n,x:i,y:s,size:r,verify:c}})(),X=(()=>{const t={size:0},e=M(t),o=O(t),n=t.size,i=D(e,6,n);return{kind:e,timestamp:o,size:n,verify:i}})(),ct=(()=>{const t={size:0},e=M(t),o=O(t),n=t.size,i=D(e,7,n);return{kind:e,timestamp:o,size:n,verify:i}})(),_=(()=>{const t={size:0},e=M(t),o=O(t),n=S(t),i=S(t),s=S(t),r=M(t),c=t.size,a=D(e,0,c);return{kind:e,id:o,x:n,y:i,direction:s,hue:r,size:c,verify:a}})(),C=(()=>{const t={size:0},e=M(t),o=M(t),n=M(t),i=t.size,s=D(e,4,i);return{kind:e,direction:o,start:n,size:i,verify:s}})(),at=(()=>{const t={size:0},e=M(t),o=t.size,n=D(e,5,o);return{kind:e,size:o,verify:n}})(),x=(()=>{const t={size:0},e=O(t),o=S(t),n=S(t),i=S(t),s=M(t),r=M(t),c=t.size;return{id:e,x:o,y:n,direction:i,hue:s,moving:r,size:c}})(),Q=(()=>{const t={size:0},e=M(t),o=t.size,n=x.size;return{kind:e,count:r=>(r.byteLength-o)/n,size:o,verify:r=>r.byteLength>=o&&(r.byteLength-o)%n===0&&e.read(r)==1}})(),j=(()=>{const t={size:0},e=M(t),o=t.size,n=x.size;return{kind:e,count:r=>(r.byteLength-o)/n,size:o,verify:r=>r.byteLength>=o&&(r.byteLength-o)%n===0&&e.read(r)==3}})(),K=(()=>{const t={size:0},e=M(t),o=t.size,n=wt;return{kind:e,count:a=>(a.byteLength-o)/n,items:a=>({id:{read:h=>h.getUint32(o+a*n,!0),write:(h,p)=>h.setUint32(o+a*n,p,!0)}}),itemSize:n,headerSize:o,verify:a=>a.byteLength>=o&&(a.byteLength-o)%n===0&&e.read(a)===2,allocateAndInit:a=>{const h=new ArrayBuffer(o+n*a),p=new DataView(h);return e.write(p,2),p}}})();function $(t,e){return(t%e+e)%e}function Dt(t,e,o){return Math.min(Math.max(t,e),o)}function Ct(t,e){return 0<=e.x&&e.x<t.width&&0<=e.y&&e.y<t.height}function V(t,e){return Ct(t,e)?t.walls[Math.floor(e.y)*t.width+Math.floor(e.x)]:!1}function lt(t,e,o,n,i){const s=Math.floor(e-n*.5),r=Math.floor(e+n*.5),c=Math.floor(o-i*.5),a=Math.floor(o+i*.5);for(let h=s;h<=r;++h)for(let p=c;p<=a;++p)if(V(t,new y(h,p)))return!1;return!0}function Ot(t){const e={height:t.length,width:Number.MIN_VALUE,walls:[]};for(let o of t)e.width=Math.max(e.width,o.length);for(let o of t){e.walls=e.walls.concat(o);for(let n=0;n<e.width-o.length;++n)e.walls.push(!1)}return e}var et=(t=>(t[t.Key=0]="Key",t[t.Bomb=1]="Bomb",t))(et||{});function Rt(t,e){return e.alive&&t.position.sqrDistanceTo(e.position)<it*it?(e.alive=!1,!0):!1}function Tt(t){let e=[];for(let o=0;o<t;++o)e.push({position:new W,velocity:new W,lifetime:0});return e}function _t(t,e){for(let o=0;o<e.length;++o){const n=e[o];if(n.lifetime<=0)return n.lifetime=kt,n.position.copy2(t.position,.6),n.velocity.x=Math.cos(t.direction),n.velocity.y=Math.sin(t.direction),n.velocity.z=.5,n.velocity.scale(Lt),o}return null}function Wt(t,e,o){let n=!1;t.lifetime-=o,t.velocity.z-=mt*o;const i=t.position.x+t.velocity.x*o,s=t.position.y+t.velocity.y*o;if(V(e,new y(i,s))){const c=Math.abs(Math.floor(t.position.x)-Math.floor(i)),a=Math.abs(Math.floor(t.position.y)-Math.floor(s));c>0&&(t.velocity.x*=-1),a>0&&(t.velocity.y*=-1),t.velocity.scale(st),t.velocity.length()>1&&(n=!0)}else t.position.x=i,t.position.y=s;const r=t.position.z+t.velocity.z*o;return r<gt||r>1?(t.velocity.z*=-1,t.velocity.scale(st),t.velocity.length()>1&&(n=!0)):t.position.z=r,n}function Nt(){const t=Ot([[!1,!1,!0,!0,!0,!1,!1],[!1,!1,!1,!1,!1,!0,!1],[!0,!1,!1,!1,!1,!0,!1],[!0,!1,!1,!1,!1,!0,!1],[!0],[!1,!0,!0,!0,!1,!1,!1],[!1,!1,!1,!1,!1,!1,!1]]),e=[{kind:1,position:new y(1.5,3.5),alive:!0},{kind:0,position:new y(2.5,1.5),alive:!0},{kind:0,position:new y(3,1.5),alive:!0},{kind:0,position:new y(3.5,1.5),alive:!0},{kind:0,position:new y(4,1.5),alive:!0},{kind:0,position:new y(4.5,1.5),alive:!0}],o=Tt(20);return{scene:t,items:e,bombs:o}}function ft(t,e,o){const n=new y;let i=0;t.moving>>0&1&&n.add(new y().setPolar(t.direction,nt)),t.moving>>1&1&&n.sub(new y().setPolar(t.direction,nt)),t.moving>>2&1&&(i-=Math.PI),t.moving>>3&1&&(i+=Math.PI),t.direction=t.direction+i*o;const s=t.position.x+n.x*o;lt(e,s,t.position.y,U,U)&&(t.position.x=s);const r=t.position.y+n.y*o;lt(e,t.position.x,r,U,U)&&(t.position.y=r)}const Ft=async(t={},e)=>{let o;if(e.startsWith("data:")){const n=e.replace(/^data:.*?base64,/,"");let i;if(typeof Buffer=="function"&&typeof Buffer.from=="function")i=Buffer.from(n,"base64");else if(typeof atob=="function"){const s=atob(n);i=new Uint8Array(s.length);for(let r=0;r<s.length;r++)i[r]=s.charCodeAt(r)}else throw new Error("Failed to decode base64-encoded data URL, Buffer and atob are not supported");o=await WebAssembly.instantiate(i,t)}else{const n=await fetch(e),i=n.headers.get("Content-Type")||"";if("instantiateStreaming"in WebAssembly&&i.startsWith("application/wasm"))o=await WebAssembly.instantiateStreaming(n,t);else{const s=await n.arrayBuffer();o=await WebAssembly.instantiate(s,t)}}return o.instance},Ht=t=>Ft(t,"/assets/renderer-CM6HW2lB.wasm?init"),R=1e-6,G=.1,Y=10,qt=Math.PI*.5,vt=30,Vt=Math.floor(16*vt),Ut=Math.floor(9*vt),$t=.7,ut=.07,Gt=50,Yt=1,ht=.8,dt=.05,Zt=8,Jt=new ot(1,.5,.15,1),Xt=8,yt={ArrowLeft:B.TurningLeft,ArrowRight:B.TurningRight,ArrowUp:B.MovingForward,ArrowDown:B.MovingBackward,KeyA:B.TurningLeft,KeyD:B.TurningRight,KeyW:B.MovingForward,KeyS:B.MovingBackward};function Qt(){return{items:[],length:0}}function jt(t){t.length=0}function tt(t,e){return e>0?Math.ceil(t+Math.sign(e)*R):e<0?Math.floor(t+Math.sign(e)*R):t}function xt(t,e){const o=e.x-t.x,n=e.y-t.y;return new y(Math.floor(e.x+Math.sign(o)*R),Math.floor(e.y+Math.sign(n)*R))}function Kt(t,e){let o=e.clone();const n=e.x-t.x,i=e.y-t.y;if(n!==0){const s=i/n,r=t.y-s*t.x;{const c=tt(e.x,n),a=c*s+r;o.set(c,a)}if(s!==0){const c=tt(e.y,i),a=(c-r)/s,h=new y(a,c);e.sqrDistanceTo(h)<e.sqrDistanceTo(o)&&o.copy(h)}}else{const s=tt(e.y,i),r=e.x;o.set(r,s)}return o}function te(t,e,o){let n=e;for(;n.sqrDistanceTo(e)<Y*Y;){const i=xt(e,o);if(V(t,i))break;const s=Kt(e,o);e=o,o=s}return o}function ee(t,e,o){t.font="28px bold",o.dts.push(e),o.dts.length>60&&o.dts.shift();const i=o.dts.reduce((a,h)=>a+h,0)/o.dts.length,s=[];switch(s.push(`FPS: ${Math.floor(1/i)}`),o.ws.readyState){case WebSocket.CONNECTING:s.push("Connecting...");break;case WebSocket.OPEN:s.push(`Ping: ${o.ping.toFixed(2)}ms`),s.push(`Players: ${o.players.size}`);break;case WebSocket.CLOSING:case WebSocket.CLOSED:s.push("Offline");break}const r=28*.06,c=70;for(let a=0;a<s.length;++a)t.fillStyle="black",t.fillText(s[a],c,c+28*a),t.fillStyle="white",t.fillText(s[a],c+r,c-r+28*a)}function oe(t,e,o,n,i){if(e instanceof ot){const s=t.backImageHeight/t.zBuffer[o],r=1/t.zBuffer[o]*2;for(let c=0;c<Math.ceil(s);++c){const h=((Math.floor((t.backImageHeight-s)*.5)+c)*t.backImageWidth+o)*4;t.backImageData[h+0]=e.r*r*255,t.backImageData[h+1]=e.g*r*255,t.backImageData[h+2]=e.b*r*255}}else if(e instanceof ImageData){const s=t.backImageHeight/t.zBuffer[o];let r=0;const c=n.clone().sub(i);Math.abs(c.x)<R&&c.y>0?r=c.y:Math.abs(c.x-1)<R&&c.y>0?r=1-c.y:Math.abs(c.y)<R&&c.x>0?r=1-c.x:r=c.x;const a=(t.backImageHeight-s)*.5,h=Math.ceil(a),p=Math.floor(h+s),w=Math.max(0,h),v=Math.min(t.backImageHeight,p),b=Math.floor(r*e.width),k=e.height/s,u=Math.min(1/t.zBuffer[o]*4,1);for(let z=w;z<v;++z){const P=Math.floor((z-a)*k),l=(z*t.backImageWidth+o)*4,m=(P*e.width+b)*4;t.backImageData[l+0]=e.data[m+0]*u,t.backImageData[l+1]=e.data[m+1]*u,t.backImageData[l+2]=e.data[m+2]*u}}}function ne(t,e,o,n){const i=new y().setPolar(o.direction);for(let s=0;s<t.backImageWidth;++s){const r=te(n,o.position,o.fovLeft.clone().lerp(o.fovRight,s/t.backImageWidth)),c=xt(o.position,r),a=r.clone().sub(o.position);t.zBuffer[s]=a.dot(i),V(n,c)&&oe(t,e.wallImageData,s,r,c)}}function ie(t,e,o,n){const i=bt(o,n),s=new Uint8ClampedArray(e,i,o*n*4);s.fill(255);const c=new OffscreenCanvas(o,n).getContext("2d");if(c===null)throw new Error("2D context is not supported");return c.imageSmoothingEnabled=!1,{ctx:t,backCtx:c,backImageData:s,backImageWidth:o,backImageHeight:n,zBuffer:Array(o).fill(0)}}function se(t){t.backCtx.putImageData(new ImageData(t.backImageData,t.backImageWidth),0,0),t.ctx.drawImage(t.backCtx.canvas,0,0,t.ctx.canvas.width,t.ctx.canvas.height)}function re(t,e,o){const n=new y,i=new y().setPolar(t.direction),s=t.fovRight.clone().sub(t.fovLeft);o.length=0;for(let r=0;r<e.length;++r){const c=e.items[r];n.copy(c.position).sub(t.position);const a=n.length();if(a<=G||a>=Y)continue;const h=n.dot(i)/a;h<0||(c.dist=G/h,n.norm().scale(c.dist).add(t.position).sub(t.fovLeft),c.t=n.length()/s.length()*Math.sign(n.dot(s)),c.pdist=c.position.clone().sub(t.position).dot(i),!(c.pdist<G)&&(c.pdist>=Y||o.push(c)))}o.sort((r,c)=>c.pdist-r.pdist)}function ce(t,e){for(let o of e){const n=t.backImageWidth*o.t,i=t.backImageHeight*.5,s=t.backImageHeight/o.pdist,r=s*o.scale,c=Math.floor(n-r*.5),a=Math.floor(c+r-1),h=Math.max(0,c),p=Math.min(t.backImageWidth-1,a),w=Math.floor(i+s*.5-s*o.z),v=Math.floor(w+r-1),b=Math.max(0,w),k=Math.min(t.backImageHeight-1,v);if(o.image instanceof ImageData){const u=o.image.data,z=t.backImageData;for(let P=h;P<=p;++P)if(o.pdist<t.zBuffer[P])for(let l=b;l<=k;++l){const m=Math.floor((P-c)/r*o.cropSize.x),f=((Math.floor((l-w)/r*o.cropSize.y)+o.cropPosition.y)*o.image.width+(m+o.cropPosition.x))*4,I=(l*t.backImageWidth+P)*4,g=u[f+3]/255;z[I+0]=z[I+0]*(1-g)+u[f+0]*g,z[I+1]=z[I+1]*(1-g)+u[f+1]*g,z[I+2]=z[I+2]*(1-g)+u[f+2]*g}}else if(o.image instanceof ot){const u=t.backImageData;for(let z=h;z<=p;++z)if(o.pdist<t.zBuffer[z])for(let P=b;P<=k;++P){const l=(P*t.backImageWidth+z)*4,m=o.image.a;u[l+0]=u[l+0]*(1-m)+o.image.r*255*m,u[l+1]=u[l+1]*(1-m)+o.image.g*255*m,u[l+2]=u[l+2]*(1-m)+o.image.b*255*m}}}}function Z(t,e,o,n,i,s,r){t.length>=t.items.length&&t.items.push({image:e,position:new y,z:n,scale:i,pdist:0,dist:0,t:0,cropPosition:new y,cropSize:new y});const c=t.length;t.items[c].image=e,t.items[c].position.copy(o),t.items[c].z=n,t.items[c].scale=i,t.items[c].pdist=0,t.items[c].dist=0,t.items[c].t=0,e instanceof ImageData?(s===void 0?t.items[c].cropPosition.set(0,0):t.items[c].cropPosition.copy(s),r===void 0?t.items[c].cropSize.set(e.width,e.height).sub(t.items[c].cropPosition):t.items[c].cropSize.copy(r)):(t.items[c].cropPosition.set(0,0),t.items[c].cropSize.set(0,0)),t.length+=1}function ae(t,e){const o=qt*.5,n=G/Math.cos(o);e.position.copy(t.position),e.direction=t.direction,e.fovLeft.setPolar(e.direction-o,n).add(e.position),e.fovRight.setPolar(e.direction+o,n).add(e.position)}function le(t,e){switch(t){case et.Key:return e.keyImageData;case et.Bomb:return e.bombImageData;default:return e.nullImageData}}function fe(t,e,o,n,i,s){for(let r of i)r.alive&&Z(e,le(r.kind,s),r.position,.25+ut-ut*Math.sin($t*Math.PI*o+r.position.x+r.position.y),.25);if(t.readyState!=WebSocket.OPEN)for(let r of i)Rt(n,r)&&J(s.itemPickupSound,n.position,r.position)}function ue(t){let e=[];for(let o=0;o<t;++o)e.push({position:new W,velocity:new W,lifetime:0});return e}function he(t,e,o,n){for(let i of n)if(i.lifetime>0){i.lifetime-=e,i.velocity.z-=mt*e;const s=i.position.x+i.velocity.x*e,r=i.position.y+i.velocity.y*e;if(V(o,new y(s,r))){const a=Math.abs(Math.floor(i.position.x)-Math.floor(s)),h=Math.abs(Math.floor(i.position.y)-Math.floor(r));a>0&&(i.velocity.x*=-1),h>0&&(i.velocity.y*=-1),i.velocity.scale(ht)}else i.position.x=s,i.position.y=r;const c=i.position.z+i.velocity.z*e;c<dt||c>1?(i.velocity.z*=-1,i.velocity.scale(ht)):i.position.z=c,i.lifetime>0&&Z(t,Jt,new y(i.position.x,i.position.y),i.position.z,dt)}}function de(t,e){for(let o of e)if(o.lifetime<=0){o.lifetime=Yt,o.position.copy(t);const n=Math.random()*2*Math.PI;o.velocity.x=Math.cos(n),o.velocity.y=Math.sin(n),o.velocity.z=Math.random()*.5+.5,o.velocity.scale(Zt*Math.random());break}}function J(t,e,o){const i=o.distanceTo(e);t.volume=Dt(1/i,0,1),t.currentTime=0,t.play()}function pt(t,e,o,n){J(o.bombBlastSound,e.position,t.position.clone2());for(let i=0;i<Gt;++i)de(t.position,n)}function ye(t,e,o,n,i,s,r,c){for(let a of n)a.lifetime>0&&(Z(e,c.bombImageData,new y(a.position.x,a.position.y),a.position.z,gt),Wt(a,s,r)&&J(c.bombRicochetSound,o.position,a.position.clone2()),t.readyState!=WebSocket.OPEN&&a.lifetime<=0&&pt(a,o,c,i))}async function me(t){const e=new Image;return e.src=t,new Promise((o,n)=>{e.onload=()=>o(e),e.onerror=n})}async function H(t){const e=await me(t),n=new OffscreenCanvas(e.width,e.height).getContext("2d");if(n===null)throw new Error("2d canvas is not supported");return n.drawImage(e,0,0),n.getImageData(0,0,e.width,e.height)}async function ge(){const[t,e,o,n,i]=await Promise.all([H("images/custom/wall.png"),H("images/custom/key.png"),H("images/custom/bomb.png"),H("images/custom/player.png"),H("images/custom/null.png")]),s=new Audio("sounds/bomb-pickup.ogg"),r=new Audio("sounds/ricochet.wav"),c=new Audio("sounds/blast.ogg"),a={wallImageData:t,keyImageData:e,bombImageData:o,playerImageData:n,nullImageData:i,bombRicochetSound:r,itemPickupSound:s,bombBlastSound:c},h=ue(1e3),p=[],w=Qt(),v=new Map,b={position:new y,direction:0,fovLeft:new y,fovRight:new y},k=window.location.protocol==="https:"?"wss:":"ws:",u=new WebSocket(`${k}//${window.location.hostname}:${Et}`);window.location.hostname==="tsoding.github.io"&&u.close();const z={id:0,position:new y,direction:0,moving:0,hue:0},P=Nt();for(const m of P.items)m.alive=!1;const l={camera:b,ws:u,me:z,ping:0,players:v,particles:h,assets:a,spritePool:w,visibleSprites:p,dts:[],level:P};return u.binaryType="arraybuffer",u.addEventListener("close",m=>{console.log("WEBSOCKET CLOSE",m),l.players.clear()}),u.addEventListener("error",m=>{console.log("WEBSOCKET ERROR",m)}),u.addEventListener("message",m=>{m.data instanceof ArrayBuffer||(console.error("Received bogus-amogus message from server. Expected binary data",m),u==null||u.close());const d=new DataView(m.data);if(_.verify(d))l.me={id:_.id.read(d),position:new y(_.x.read(d),_.y.read(d)),direction:_.direction.read(d),moving:0,hue:_.hue.read(d)/256*360},v.set(l.me.id,l.me);else if(Q.verify(d)){const f=Q.count(d);for(let I=0;I<f;++I){const g=new DataView(m.data,Q.size+I*x.size,x.size),T=x.id.read(g),E=v.get(T);if(E!==void 0)E.position.x=x.x.read(g),E.position.y=x.y.read(g),E.direction=x.direction.read(g),E.moving=x.moving.read(g),E.hue=x.hue.read(g)/256*360;else{const It=x.x.read(g),St=x.y.read(g);v.set(T,{id:T,position:new y(It,St),direction:x.direction.read(g),moving:x.moving.read(g),hue:x.hue.read(g)/256*360})}}}else if(K.verify(d)){const f=K.count(d);for(let I=0;I<f;++I){const g=K.items(I).id.read(d);v.delete(g)}}else if(j.verify(d)){const f=j.count(d);for(let I=0;I<f;++I){const g=new DataView(m.data,j.size+I*x.size,x.size),T=x.id.read(g),E=v.get(T);if(E===void 0){console.error(`Received bogus-amogus message from server. We don't know anything about player with id ${T}`),u==null||u.close();return}E.moving=x.moving.read(g),E.position.x=x.x.read(g),E.position.y=x.y.read(g),E.direction=x.direction.read(g)}}else if(ct.verify(d))l.ping=performance.now()-ct.timestamp.read(d);else if(rt.verify(d)){const f=rt.index.read(d);if(!(0<=f&&f<l.level.items.length)){console.error(`Received bogus-amogus ItemCollected message from server. Invalid index ${f}`),u==null||u.close();return}l.level.items[f].alive&&(l.level.items[f].alive=!1,J(a.itemPickupSound,l.me.position,l.level.items[f].position))}else if(F.verify(d)){const f=F.index.read(d);if(!(0<=f&&f<l.level.items.length)){console.error(`Received bogus-amogus ItemSpawned message from server. Invalid index ${f}`),u==null||u.close();return}l.level.items[f].alive=!0,l.level.items[f].kind=F.itemKind.read(d),l.level.items[f].position.x=F.x.read(d),l.level.items[f].position.y=F.y.read(d)}else if(A.verify(d)){const f=A.index.read(d);if(!(0<=f&&f<l.level.bombs.length)){console.error(`Received bogus-amogus BombSpawned message from server. Invalid index ${f}`),u==null||u.close();return}l.level.bombs[f].lifetime=A.lifetime.read(d),l.level.bombs[f].position.x=A.x.read(d),l.level.bombs[f].position.y=A.y.read(d),l.level.bombs[f].position.z=A.z.read(d),l.level.bombs[f].velocity.x=A.dx.read(d),l.level.bombs[f].velocity.y=A.dy.read(d),l.level.bombs[f].velocity.z=A.dz.read(d)}else if(N.verify(d)){const f=N.index.read(d);if(!(0<=f&&f<l.level.bombs.length)){console.error(`Received bogus-amogus BombExploded message from server. Invalid index ${f}`),u==null||u.close();return}l.level.bombs[f].lifetime=0,l.level.bombs[f].position.x=N.x.read(d),l.level.bombs[f].position.y=N.y.read(d),l.level.bombs[f].position.z=N.z.read(d),pt(P.bombs[f],z,a,h)}else console.error("Received bogus-amogus message from server.",d),u==null||u.close()}),u.addEventListener("open",m=>{console.log("WEBSOCKET OPEN",m)}),l}function we(t,e){return Math.floor($($(e.direction,2*Math.PI)-$(e.position.clone().sub(t).angle(),2*Math.PI)-Math.PI+Math.PI/8,2*Math.PI)/(2*Math.PI)*Xt)}function ve(t,e,o,n){jt(n.spritePool),n.players.forEach(i=>{i!==n.me&&ft(i,n.level.scene,e)}),ft(n.me,n.level.scene,e),ae(n.me,n.camera),fe(n.ws,n.spritePool,o,n.me,n.level.items,n.assets),ye(n.ws,n.spritePool,n.me,n.level.bombs,n.particles,n.level.scene,e,n.assets),he(n.spritePool,e,n.level.scene,n.particles),n.players.forEach(i=>{if(i!==n.me){const s=we(n.camera.position,i);Z(n.spritePool,n.assets.playerImageData,i.position,1,1,new y(55*s,0),new y(55,55))}}),zt(n.camera.position.x,n.camera.position.y,$(n.camera.direction,2*Math.PI)),ne(t,n.assets,n.camera,n.level.scene),re(n.camera,n.spritePool,n.visibleSprites),ce(t,n.visibleSprites),se(t),ee(t.ctx,e,n)}function xe(...t){return new Proxy(t,{get(e,o,n){for(let i of t)if(i.hasOwnProperty(o))return i[o];return(...i)=>{throw new Error(`NOT IMPLEMENTED: ${String(o)} ${i}`)}}})}let bt,zt;(async()=>{const t=document.getElementById("game");if(t===null)throw new Error("No canvas with id `game` is found");const e=80;t.width=16*e,t.height=9*e;const o=t.getContext("2d");if(o===null)throw new Error("2D context is not supported");o.imageSmoothingEnabled=!1;const{exports:n}=await Ht({env:xe({fmodf:(w,v)=>w%v,fminf:Math.min,fmaxf:Math.max})}),i=n.memory;bt=n.allocate_pixels,zt=n.render_floor_and_ceiling;const s=await ge(),r=ie(o,i.buffer,Vt,Ut);window.addEventListener("keydown",w=>{if(!w.repeat){const v=yt[w.code];if(v!==void 0)if(s.ws.readyState===WebSocket.OPEN){const b=new DataView(new ArrayBuffer(C.size));C.kind.write(b,q.AmmaMoving),C.start.write(b,1),C.direction.write(b,v),s.ws.send(b)}else s.me.moving|=1<<v;else if(w.code==="Space")if(s.ws.readyState===WebSocket.OPEN){const b=new DataView(new ArrayBuffer(at.size));at.kind.write(b,q.AmmaThrowing),s.ws.send(b)}else _t(s.me,s.level.bombs)}}),window.addEventListener("keyup",w=>{if(!w.repeat){const v=yt[w.code];if(v!==void 0)if(s.ws.readyState===WebSocket.OPEN){const b=new DataView(new ArrayBuffer(C.size));C.kind.write(b,q.AmmaMoving),C.start.write(b,0),C.direction.write(b,v),s.ws.send(b)}else s.me.moving&=~(1<<v)}});const c=60;let a=0,h=c;const p=w=>{const v=(w-a)/1e3,b=w/1e3;if(a=w,ve(r,v,b,s),s.ws.readyState==WebSocket.OPEN&&(h-=1,h<=0)){const k=new DataView(new ArrayBuffer(X.size));X.kind.write(k,q.Ping),X.timestamp.write(k,performance.now()),s.ws.send(k),h=c}window.requestAnimationFrame(p)};window.requestAnimationFrame(w=>{a=w,window.requestAnimationFrame(p)})})();
//# sourceMappingURL=index-C9Yo8tSO.js.map
